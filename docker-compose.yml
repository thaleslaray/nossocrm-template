# =============================================================================
# NossoCRM - Docker Compose (Simplified Approach)
# =============================================================================
# This setup runs the web application in Docker while connecting to
# Supabase running locally via CLI (npx supabase start)
# 
# Prerequisites:
# 1. Run: npx supabase start
# 2. Copy .env.example to .env and configure Supabase URLs
# 3. Run: docker-compose up
# =============================================================================

services:
  web:
    container_name: nossocrm-web
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    restart: unless-stopped
    
    # Environment variables
    env_file:
      - .env
    
    environment:
      # Vite configuration
      NODE_ENV: development
      CI: true
 
      # Connect to Supabase running on host machine
      # Use host.docker.internal to access host's localhost
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-http://host.docker.internal:54321}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}

      # Optional: AI API keys
      VITE_GEMINI_API_KEY: ${VITE_GEMINI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    
    # Port mapping
    ports:
      - "3000:3001"  # Vite dev server
      # - "3000:5173"  # Vite dev server
    
    # Volume mounts for hot-reload
    volumes:
      - ./:/app                    # Source code
      - /app/node_modules          # Prevent node_modules overwrite
      - /app/.git                  # Prevent git directory overwrite
    
    # Network configuration
    extra_hosts:
      # Allow container to access host's Supabase instance
      - "host.docker.internal:host-gateway"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
